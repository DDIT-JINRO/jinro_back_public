<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.prg.ctt.service.impl.ContestMapper">

	<!--
	// 검색 조건에 맞는 공모전 총 개수 조회 (페이징 처리를 위함)
    int selectCttCount(ContestVO contestVO);
	 -->
	<select id="selectCttCount" parameterType="kr.or.ddit.prg.ctt.service.ContestVO">
        SELECT COUNT(*)
        FROM CONTEST T1
         <where>
         	T1.CONTEST_DEL_YN = 'N'
            <if test="keyword != null and keyword != ''">
                AND (CONTEST_TITLE LIKE '%' || #{keyword} || '%' OR CONTEST_DESCRIPTION LIKE '%' || #{keyword} || '%')
            </if>
            <if test="contestGubunFilter != null and contestGubunFilter.size() > 0">
                AND T1.CONTEST_GUBUN IN
                <foreach item="item" collection="contestGubunFilter" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="contestTargetFilter != null and contestTargetFilter.size() > 0">
                AND T1.CONTEST_TARGET IN
                <foreach item="item" collection="contestTargetFilter" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="contestTypeFilter != null and contestTypeFilter.size() > 0">
                AND T1.CONTEST_TYPE IN
                <foreach item="item" collection="contestTypeFilter" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="contestStatusFilter != null and contestStatusFilter.size() > 0">
            	AND
                <foreach item="status" collection="contestStatusFilter" separator=" OR " open="(" close=")">
                    <if test="status == 'proceeding'">
                        CONTEST_END_DATE >= TRUNC(SYSDATE)
                    </if>
                    <if test="status == 'finished'">
                        CONTEST_END_DATE &lt; TRUNC(SYSDATE)
                    </if>
                </foreach>
            </if>
        </where>
    </select>

	<!--
	// 검색 조건 및 페이징에 맞는 공모전 목록 조회
    List<ContestVO> selectCttList(ContestVO contestVO);
	 -->
    <select id="selectCttList" parameterType="kr.or.ddit.prg.ctt.service.ContestVO" resultType="kr.or.ddit.prg.ctt.service.ContestVO">
        SELECT *
        FROM (
            SELECT
                 ROW_NUMBER() OVER(
	                 ORDER BY
	                	<choose>
						 	<when test="sortOrder == 'id'">
		                    	T1.CONTEST_ID,
						 	</when>
					 	</choose>
	                     CASE WHEN T1.CONTEST_END_DATE >= TRUNC(SYSDATE) THEN 1 ELSE 2 END, -- 1. 진행중인 공모전 먼저
						 <choose>
						 	<when test="sortOrder == 'latest'">
		                    	T1.CONTEST_END_DATE DESC -- '최신순' 선택 시: 등록일 내림차순
						 	</when>
						 	<when test="sortOrder == 'deadline'">
						 		T1.CONTEST_END_DATE ASC,  -- '마감일순' 선택 시: 마감일 오름차순
              					T1.CONTEST_CREATED_AT DESC  -- (2차 정렬) 마감일이 같으면 최신 등록순
						 	</when>
						 	<otherwise>
	                     		T1.CONTEST_END_DATE ASC,  -- '마감일순' 선택 시: 마감일 오름차순
              					T1.CONTEST_CREATED_AT DESC  -- (2차 정렬) 마감일이 같으면 최신 등록순
						 	</otherwise>
						 </choose>
	             ) AS RNUM
                ,T1.CONTEST_ID           AS contestId
                ,T1.CONTEST_TITLE        AS contestTitle
                ,T1.CONTEST_GUBUN        AS contestGubunCode
                ,GUBUN.CC_NAME           AS contestGubunName
                ,T1.CONTEST_DESCRIPTION  AS contestDescription
                ,T1.CONTEST_TYPE         AS contestType
                ,TYPE.CC_NAME            AS contestTypeName
                ,T1.CONTEST_TARGET       AS contestTarget
                ,TARGET.CC_NAME          AS contestTargetName
                ,T1.CONTEST_START_DATE   AS contestStartDate
                ,T1.CONTEST_END_DATE     AS contestEndDate
                ,T1.CONTEST_CREATED_AT   AS contestCreatedAt
                ,T1.CONTEST_RECRUIT_COUNT AS contestRecruitCount
                ,T1.CONTEST_URL          AS contestUrl
                ,T1.FILE_GROUP_ID        AS fileGroupId
                ,T1.CONTEST_HOST         AS contestHost
             	,T1.CONTEST_ORGANIZER    AS contestOrganizer
             	,T1.CONTEST_SPONSOR      AS contestSponsor
             	,T1.APPLICATION_METHOD   AS applicationMethod
             	,T1.AWARD_TYPE           AS awardType
            FROM CONTEST T1
            LEFT JOIN COM_CODE GUBUN
                ON T1.CONTEST_GUBUN = GUBUN.CC_ID
                AND GUBUN.CL_CODE = 'G32'
            LEFT JOIN COM_CODE TYPE
                ON T1.CONTEST_TYPE = TYPE.CC_ID
                AND TYPE.CL_CODE = 'G35'
            LEFT JOIN COM_CODE TARGET
                ON T1.CONTEST_TARGET = TARGET.CC_ID
                AND TARGET.CL_CODE = 'G34'
            <where>
            	T1.CONTEST_DEL_YN = 'N'
            	and T1.CONTEST_GUBUN = 'G32001'
                <if test="keyword != null and keyword != ''">
                    AND (T1.CONTEST_TITLE LIKE '%' || #{keyword} || '%' OR T1.CONTEST_DESCRIPTION LIKE '%' || #{keyword} || '%')
                </if>
                <if test="contestGubunFilter != null and contestGubunFilter.size() > 0">
                    AND T1.CONTEST_GUBUN IN
                    <foreach item="item" collection="contestGubunFilter" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </if>
                <if test="contestTargetFilter != null and contestTargetFilter.size() > 0">
                    AND T1.CONTEST_TARGET IN
                    <foreach item="item" collection="contestTargetFilter" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </if>
                <if test="contestTypeFilter != null and contestTypeFilter.size() > 0">
                    AND T1.CONTEST_TYPE IN
                    <foreach item="item" collection="contestTypeFilter" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </if>
                <if test="contestStatusFilter != null and contestStatusFilter.size() > 0">
                	AND
	                <foreach item="status" collection="contestStatusFilter" separator=" OR " open="(" close=")">
	                    <if test="status == 'proceeding'">
	                        CONTEST_END_DATE >= TRUNC(SYSDATE)
	                    </if>
	                    <if test="status == 'finished'">
	                        CONTEST_END_DATE &lt; TRUNC(SYSDATE)
	                    </if>
	                </foreach>
	            </if>
            </where>
        )
        WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

	<!--
	// 공모전 상세 정보를 조회하는 메서드
    ContestVO selectCttDetail(String cttId);
	 -->
    <select id="selectCttDetail" resultType="kr.or.ddit.prg.ctt.service.ContestVO">
        SELECT
             T1.CONTEST_ID           AS contestId
            ,T1.CONTEST_TITLE        AS contestTitle
            ,T1.CONTEST_GUBUN        AS contestGubunCode
            ,GUBUN.CC_NAME           AS contestGubunName
            ,T1.CONTEST_DESCRIPTION  AS contestDescription
            ,T1.CONTEST_TYPE         AS contestType
            ,TYPE.CC_NAME            AS contestTypeName
            ,T1.CONTEST_TARGET       AS contestTarget
            ,TARGET.CC_NAME          AS contestTargetName
            ,T1.CONTEST_START_DATE   AS contestStartDate
            ,T1.CONTEST_END_DATE     AS contestEndDate
            ,T1.CONTEST_CREATED_AT   AS contestCreatedAt
            ,T1.CONTEST_RECRUIT_COUNT AS contestRecruitCount
            ,T1.CONTEST_URL          AS contestUrl
            ,T1.FILE_GROUP_ID        AS fileGroupId
            ,T1.CONTEST_HOST         AS contestHost
         	,T1.CONTEST_ORGANIZER    AS contestOrganizer
         	,T1.CONTEST_SPONSOR      AS contestSponsor
         	,T1.APPLICATION_METHOD   AS applicationMethod
         	,T1.AWARD_TYPE           AS awardType
        FROM CONTEST T1
        LEFT JOIN COM_CODE GUBUN
            ON T1.CONTEST_GUBUN = GUBUN.CC_ID AND GUBUN.CL_CODE = 'G32'
        LEFT JOIN COM_CODE TYPE
            ON T1.CONTEST_TYPE = TYPE.CC_ID AND TYPE.CL_CODE = 'G35'
        LEFT JOIN COM_CODE TARGET
            ON T1.CONTEST_TARGET = TARGET.CC_ID AND TARGET.CL_CODE = 'G34'
        WHERE CONTEST_ID = #{cttId}  AND T1.CONTEST_DEL_YN = 'N'
    </select>
	<!--
	공모전분류 목록 조회
    public List<ComCodeVO> selectContestTypeList()
	 -->
	<select id="selectContestTypeList" resultType="kr.or.ddit.com.ComCodeVO">
        SELECT
        	 CC_ID
        	,CC_NAME
        FROM COM_CODE
        WHERE CL_CODE = 'G35'
        ORDER BY CC_NAME
    </select>

    <!--
    모집 대상 목록 조회
    public List<ComCodeVO> selectContestTargetList()
     -->
    <select id="selectContestTargetList" resultType="kr.or.ddit.com.ComCodeVO">
        SELECT
        	 CC_ID
        	,CC_NAME
        FROM COM_CODE
        WHERE CL_CODE = 'G34'
        ORDER BY CC_NAME
    </select>

    <!--
    //공모전 조회수 증가 메소드
    public int updateCttViewCount(String cttId);
     -->
    <update id="updateCttViewCount">
    UPDATE CONTEST
	    SET CONTEST_RECRUIT_COUNT = CONTEST_RECRUIT_COUNT + 1
	    WHERE CONTEST_ID = #{cttId}
	</update>

	<!--
	 // MERGE
    public int updateContest(ContestVO contestVO);
	 -->
	<update id="updateContest" parameterType="kr.or.ddit.prg.ctt.service.ContestVO">
	    MERGE INTO CONTEST A
	    USING (
	        SELECT
	            #{contestId, jdbcType=VARCHAR} AS CONTEST_ID
	        FROM DUAL
	    ) B
	    ON (A.CONTEST_ID = B.CONTEST_ID)
	    WHEN MATCHED THEN
	        UPDATE SET
	              A.CONTEST_TITLE      = #{contestTitle}
	            , A.CONTEST_GUBUN      = #{contestGubunCode}
	            , A.CONTEST_DESCRIPTION = #{contestDescription}
	            , A.CONTEST_TYPE       = #{contestType}
	            , A.CONTEST_TARGET     = #{contestTarget}
	            , A.CONTEST_START_DATE = #{contestStartDate}
	            , A.CONTEST_END_DATE   = #{contestEndDate}
	            , A.CONTEST_HOST       = #{contestHost}
	            , A.CONTEST_ORGANIZER  = #{contestOrganizer}
	            , A.CONTEST_SPONSOR    = #{contestSponsor}
	            , A.APPLICATION_METHOD = #{applicationMethod}
	            , A.AWARD_TYPE         = #{awardType}
	            , A.CONTEST_URL        = #{contestUrl}
	            <if test="fileGroupId != null and fileGroupId != ''">
	            , A.FILE_GROUP_ID      = #{fileGroupId}
	            </if>
	    WHEN NOT MATCHED THEN
	        INSERT (
	              CONTEST_ID, CONTEST_TITLE
	            , CONTEST_GUBUN
	            , CONTEST_DESCRIPTION
	            , CONTEST_TYPE
	            , CONTEST_TARGET
	            , CONTEST_START_DATE
	            , CONTEST_END_DATE
	            , CONTEST_HOST
	            , CONTEST_ORGANIZER
	            , CONTEST_SPONSOR
	            , APPLICATION_METHOD
	            , AWARD_TYPE
	            , CONTEST_URL
	            , FILE_GROUP_ID
	        ) VALUES (
	            CONTEST_SEQ.NEXTVAL
	            , #{contestTitle}
	            , #{contestGubunCode}
	            , #{contestDescription}
	            , #{contestType}
	            , #{contestTarget}
	            , #{contestStartDate}
	            , #{contestEndDate}
	            , #{contestHost}
	            , #{contestOrganizer}
	            , #{contestSponsor}
	            , #{applicationMethod}
	            , #{awardType}
	            , #{contestUrl}
	            , #{fileGroupId}
	        )
	</update>

	<!--
	 //delete
    public int deleteContest(String contestId);
     -->
    <update id="deleteContest">
        UPDATE CONTEST
        SET CONTEST_DEL_YN = 'Y'
        WHERE CONTEST_ID = #{contestId}
    </update>

    <select id="selectContestBanner" resultType="map" parameterType="map">
    	SELECT * FROM (
			SELECT C.CONTEST_TITLE AS "contestTitle"
			     , C.CONTEST_GUBUN AS "contestGubun"
			     , C.CONTEST_ID AS "contestId"
			     , C.CONTEST_TARGET AS "contestType"
			     , '/prg/ctt/cttDetail.do?cttId='||C.CONTEST_ID AS "contestUrl"
			     , '/files/download?fileGroupId='||FD.FILE_GROUP_ID||'&amp;seq='||FD.FILE_SEQ AS "filePath"
			  FROM CONTEST C
			  JOIN FILE_GROUP FG ON FG.FILE_GROUP_ID = C.FILE_GROUP_ID
			  JOIN FILE_DETAIL FD ON FD.FILE_GROUP_ID = FG.FILE_GROUP_ID
			 WHERE C.CONTEST_GUBUN = 'G32001'
			 <if test="age!=null and age=='teen'">
			 AND C.CONTEST_TARGET IN ('G34001','G34003')
			 </if>
			 <if test="age!=null and age=='youth'">
			 AND C.CONTEST_TARGET IN ('G34002','G34003')
			 </if>
			 ORDER BY C.CONTEST_CREATED_AT DESC, C.CONTEST_END_DATE ASC
			 FETCH FIRST 3 ROWS ONLY
		)
		UNION ALL
		SELECT * FROM (
			SELECT C.CONTEST_TITLE
			     , C.CONTEST_GUBUN
			     , C.CONTEST_ID
			     , C.CONTEST_TARGET
			     , '/prg/act/sup/supDetail.do?supId='||C.CONTEST_ID
			     , '/files/download?fileGroupId='||FD.FILE_GROUP_ID||'&amp;seq='||FD.FILE_SEQ
			  FROM CONTEST C
			  JOIN FILE_GROUP FG ON FG.FILE_GROUP_ID = C.FILE_GROUP_ID
			  JOIN FILE_DETAIL FD ON FD.FILE_GROUP_ID = FG.FILE_GROUP_ID
			 WHERE C.CONTEST_GUBUN = 'G32002'
 			 <if test="age!=null and age=='teen'">
			 AND C.CONTEST_TARGET IN ('G34001','G34003')
			 </if>
			 <if test="age!=null and age=='youth'">
			 AND C.CONTEST_TARGET IN ('G34002','G34003')
			 </if>
			 ORDER BY C.CONTEST_CREATED_AT DESC, C.CONTEST_END_DATE ASC
			 FETCH FIRST 3 ROWS ONLY
		)
		UNION ALL
		SELECT * FROM (
			SELECT C.CONTEST_TITLE
			     , C.CONTEST_GUBUN
			     , C.CONTEST_ID
			     , C.CONTEST_TARGET
			     , '/prg/act/vol/volDetail.do?volId='||C.CONTEST_ID
			     , '/files/download?fileGroupId='||FD.FILE_GROUP_ID||'&amp;seq='||FD.FILE_SEQ
			  FROM CONTEST C
			  JOIN FILE_GROUP FG ON FG.FILE_GROUP_ID = C.FILE_GROUP_ID
			  JOIN FILE_DETAIL FD ON FD.FILE_GROUP_ID = FG.FILE_GROUP_ID
			 WHERE C.CONTEST_GUBUN = 'G32003'
			 <if test="age!=null and age=='teen'">
			 AND C.CONTEST_TARGET IN ('G34001','G34003')
			 </if>
			 <if test="age!=null and age=='youth'">
			 AND C.CONTEST_TARGET IN ('G34002','G34003')
			 </if>
			 ORDER BY C.CONTEST_CREATED_AT DESC, C.CONTEST_END_DATE ASC
			 FETCH FIRST 3 ROWS ONLY
		)
		UNION ALL
		SELECT * FROM (
			SELECT C.CONTEST_TITLE
			     , C.CONTEST_GUBUN
			     , C.CONTEST_ID
			     , C.CONTEST_TARGET
			     , '/prg/act/cr/crDetail.do?crId='||C.CONTEST_ID
			     , '/files/download?fileGroupId='||FD.FILE_GROUP_ID||'&amp;seq='||FD.FILE_SEQ
			  FROM CONTEST C
			  JOIN FILE_GROUP FG ON FG.FILE_GROUP_ID = C.FILE_GROUP_ID
			  JOIN FILE_DETAIL FD ON FD.FILE_GROUP_ID = FG.FILE_GROUP_ID
			 WHERE C.CONTEST_GUBUN = 'G32004'
			 <if test="age!=null and age=='teen'">
			 AND C.CONTEST_TARGET IN ('G34001','G34003')
			 </if>
			 <if test="age!=null and age=='youth'">
			 AND C.CONTEST_TARGET IN ('G34002','G34003')
			 </if>
			 ORDER BY C.CONTEST_CREATED_AT DESC, C.CONTEST_END_DATE ASC
			 FETCH FIRST 3 ROWS ONLY
		)
    </select>

</mapper>